{% extends "base.html" %}

{% block title %}{{ ticker }} - Bloomberg{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="/static/css/bloomberg.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/htmx/1.9.12/htmx.min.js"></script>
{% endblock %}

{% block content %}
<div class="bb-top">
    <div class="bb-logo"><svg viewBox="0 0 24 24" fill="#ff9500"><rect x="2" y="2" width="8" height="8"/><rect x="14" y="2" width="8" height="8"/><rect x="2" y="14" width="8" height="8"/><rect x="14" y="14" width="8" height="8"/></svg><h1>BLOOMBERG</h1><span>SECURITY DETAIL</span></div>
    <input type="text" class="bb-cmd" placeholder="Enter ticker..." onkeydown="if(event.key==='Enter')location.href='/detail?'+this.value.toUpperCase()"/>
    <div class="bb-time">{{ current_time }} CET <span class="blink">‚óè</span></div>
</div>

<div class="bb-fkeys">
    <button class="fkey" onclick="location.href='/'">F1 PORT</button>
    <button class="fkey">F2 SCRN</button>
    <button class="fkey">F3 WTCH</button>
    <button class="fkey" onclick="location.href='/detail?{{ ticker }}&refresh=1'">F5 REFRESH</button>
    <button class="fkey active">F8 DETAIL</button>
</div>

<div class="bb-detail">
    <a href="/" class="bb-back">‚Üê Back to Portfolio</a>

    <div class="bb-detail-header">
        <div class="bb-detail-title">
            <div>
                <div class="bb-detail-name">{{ name or ticker }}</div>
                <div class="bb-detail-ticker">{{ ticker }}</div>
                <div class="bb-detail-sector">{{ sector }}{% if industry %}  -  {{ industry }}{% endif %}{% if country %}  -  {{ country }}{% endif %}</div>
            </div>
            <div style="display:flex;align-items:center;gap:16px;">
                <div class="bb-detail-price">
                    <div class="bb-detail-price-val {{ 'down' if change < 0 else '' }}">{{ price_display }} EUR</div>
                    <div class="bb-detail-change {{ 'neg' if change < 0 else 'pos' }}">{{ change_sign }}{{ change_display }} ({{ change_sign }}{{ change_pct_display }}%)</div>
                </div>
                <button class="bb-btn bb-btn-g" onclick="addToWatchlistDetail(this)" style="white-space:nowrap;padding:8px 16px;">+ WATCHLIST</button>
                <button class="bb-btn" onclick="toggleAlertConfig()" style="white-space:nowrap;padding:8px 16px;">üîî ALERTS</button>
                <button id="btn-ai-analyze" class="btn-analyze" onclick="launchAnalysis('{{ ticker }}')" style="white-space:nowrap;"><span class="analyze-icon">‚óÜ</span><span class="analyze-text">Analyser</span><span class="analyze-badge">IA</span></button>
            </div>
        </div>
    </div>

    <!-- Alert Configuration Panel -->
    <div id="alert-config-panel" class="bb-alert-config" style="display:none;">
        <div class="bb-alert-config-header">
            <span>üîî Configure Alerts for {{ ticker }}</span>
            <button onclick="toggleAlertConfig()" style="background:none;border:none;color:#888;cursor:pointer;font-size:16px;">‚úï</button>
        </div>
        <div class="bb-alert-config-body">
            <div class="bb-alert-config-row">
                <label>PE Threshold (alert when PE &lt; this)</label>
                <input type="number" id="alert-pe" value="10" step="0.5" placeholder="e.g. 10">
            </div>
            <div class="bb-alert-config-row">
                <label>ROE Threshold % (alert when ROE &gt; this)</label>
                <input type="number" id="alert-roe" value="12" step="0.5" placeholder="e.g. 12">
            </div>
            <div class="bb-alert-config-row">
                <label>Price Below (alert when price drops below)</label>
                <input type="number" id="alert-price-below" step="0.01" placeholder="e.g. {{ (price * 0.9)|int }}">
            </div>
            <div class="bb-alert-config-row">
                <label>Price Above (alert when price rises above)</label>
                <input type="number" id="alert-price-above" step="0.01" placeholder="e.g. {{ (price * 1.1)|int }}">
            </div>
            <div class="bb-alert-config-actions">
                <button class="bb-btn bb-btn-g" onclick="saveAlertConfig()">üíæ SAVE ALERTS</button>
                <button class="bb-btn" onclick="toggleAlertConfig()">CANCEL</button>
            </div>
        </div>
    </div>

    <style>
        .bb-alert-config {
            background: linear-gradient(135deg, #1a1a1a 0%, #0d0d0d 100%);
            border: 1px solid #ff9500;
            border-radius: 4px;
            margin: 15px 0;
            overflow: hidden;
        }
        .bb-alert-config-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            background: linear-gradient(90deg, rgba(255,149,0,0.2) 0%, transparent 100%);
            border-bottom: 1px solid #333;
            color: #ff9500;
            font-weight: 600;
        }
        .bb-alert-config-body {
            padding: 15px;
        }
        .bb-alert-config-row {
            margin-bottom: 12px;
        }
        .bb-alert-config-row label {
            display: block;
            color: #888;
            font-size: 11px;
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .bb-alert-config-row input {
            width: 100%;
            background: #1a1a1a;
            border: 1px solid #333;
            color: #fff;
            padding: 8px 12px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
            border-radius: 3px;
        }
        .bb-alert-config-row input:focus {
            border-color: #ff9500;
            outline: none;
        }
        .bb-alert-config-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #333;
        }
    </style>

    <style id="analysis-styles">
        /* ========================================
           AI Equity Research ‚Äî Button & Modal CSS
           ======================================== */

        /* Analyze Button */
        .btn-analyze {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            background: linear-gradient(135deg, #1a2332 0%, #111822 100%);
            border: 1px solid #00ff88;
            border-radius: 4px;
            color: #00ff88;
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            letter-spacing: 0.5px;
        }
        .btn-analyze:hover {
            background: linear-gradient(135deg, #00ff88 0%, #00cc6a 100%);
            color: #0a0e14;
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.3);
        }
        .btn-analyze:active { transform: scale(0.98); }
        .btn-analyze .analyze-icon { font-size: 14px; }
        .btn-analyze .analyze-badge {
            background: rgba(0, 255, 136, 0.15);
            padding: 1px 6px;
            border-radius: 2px;
            font-size: 9px;
            letter-spacing: 1px;
        }
        .btn-analyze:hover .analyze-badge { background: rgba(10, 14, 20, 0.3); }
        .btn-analyze.loading {
            pointer-events: none;
            opacity: 0.7;
            border-color: #ff9500;
            color: #ff9500;
        }
        .btn-analyze.loading .analyze-badge {
            background: rgba(255, 149, 0, 0.15);
            animation: analysePulse 1.5s infinite;
        }
        @keyframes analysePulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        /* Modal Fullscreen */
        .analysis-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #0a0e14;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .analysis-modal-header {
            background: #111822;
            border-bottom: 1px solid #1e2d3d;
            padding: 8px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }
        .analysis-modal-logo {
            color: #00ff88;
            font-weight: 700;
            font-size: 13px;
            letter-spacing: 2px;
        }
        .analysis-modal-meta {
            color: #484f58;
            font-size: 10px;
        }
        .analysis-modal-meta span {
            color: #ff9500;
        }
        .analysis-cache-badge {
            background: rgba(88,166,255,0.15);
            color: #58a6ff;
            padding: 1px 6px;
            border-radius: 2px;
            font-size: 8px;
            letter-spacing: 1px;
            margin-left: 8px;
            border: 1px solid rgba(88,166,255,0.3);
        }
        .analysis-modal-actions {
            display: flex;
            gap: 4px;
        }
        .modal-btn {
            background: transparent;
            border: 1px solid #1e2d3d;
            color: #8b949e;
            padding: 4px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            transition: all 0.15s;
        }
        .modal-btn:hover {
            border-color: #00ff88;
            color: #00ff88;
        }
        .modal-btn-close:hover {
            border-color: #ff4444;
            color: #ff4444;
        }

        /* Content area (scrollable) */
        .analysis-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
        }

        /* Loading */
        .analysis-loading {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 16px;
        }
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #1e2d3d;
            border-top-color: #00ff88;
            border-radius: 50%;
            animation: analyseSpin 1s linear infinite;
        }
        @keyframes analyseSpin {
            to { transform: rotate(360deg); }
        }
        .loading-text {
            color: #e6edf3;
            font-size: 14px;
            font-weight: 600;
        }
        .loading-subtext {
            color: #484f58;
            font-size: 11px;
        }
        .loading-steps {
            margin-top: 16px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .loading-step {
            color: #484f58;
            font-size: 11px;
            transition: color 0.3s;
        }
        .loading-step.active {
            color: #00ff88;
        }
        .loading-step.done {
            color: #8b949e;
        }

        /* Error */
        .analysis-error {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }
        .error-icon {
            font-size: 32px;
            color: #ff4444;
        }
        .error-text {
            color: #ff4444;
            font-size: 12px;
        }

        /* ========================================
           Equity Research Report Design System
           ======================================== */

        /* Ticker Header */
        .analysis-content .ticker-header {
            background: #111822;
            border: 1px solid #1e2d3d;
            border-radius: 4px;
            padding: 20px 24px;
            margin-bottom: 12px;
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 24px;
            align-items: start;
        }
        .analysis-content .ticker-info h1 {
            font-size: 22px;
            font-weight: 700;
            color: #e6edf3;
            margin-bottom: 2px;
        }
        .analysis-content .ticker-info h1 .ticker { color: #ff9500; }
        .analysis-content .ticker-info .subtitle { color: #8b949e; font-size: 11px; }
        .analysis-content .price-block { text-align: right; }
        .analysis-content .price-block .price {
            font-size: 32px;
            font-weight: 700;
        }
        .analysis-content .price-block .price-eur { color: #484f58; font-size: 14px; }
        .analysis-content .price-block .change { font-size: 12px; margin-top: 2px; }
        .analysis-content .price-block .asof { color: #484f58; font-size: 9px; margin-top: 4px; }

        /* Verdict Banner */
        .analysis-content .verdict-banner {
            background: linear-gradient(135deg, #1a2332 0%, #0f1922 100%);
            border: 1px solid #ff9500;
            border-left: 4px solid #ff9500;
            border-radius: 4px;
            padding: 16px 20px;
            margin-bottom: 12px;
        }
        .analysis-content .verdict-banner .verdict-label {
            color: #ff9500;
            font-size: 10px;
            font-weight: 600;
            letter-spacing: 2px;
            text-transform: uppercase;
            margin-bottom: 6px;
        }
        .analysis-content .verdict-banner .verdict-text {
            color: #e6edf3;
            font-size: 13px;
            font-weight: 500;
            line-height: 1.7;
        }

        /* Grid Layouts */
        .analysis-content .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 12px;
        }
        .analysis-content .grid-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 12px;
            margin-bottom: 12px;
        }
        @media (max-width: 900px) {
            .analysis-content .grid-2, .analysis-content .grid-3 { grid-template-columns: 1fr; }
        }

        /* Panel */
        .analysis-content .panel {
            background: #111822;
            border: 1px solid #1e2d3d;
            border-radius: 4px;
            overflow: hidden;
        }
        .analysis-content .panel-title {
            background: #1a2332;
            padding: 8px 14px;
            font-size: 10px;
            font-weight: 600;
            letter-spacing: 1.5px;
            text-transform: uppercase;
            color: #00ff88;
            border-bottom: 1px solid #1e2d3d;
        }
        .analysis-content .panel-body {
            padding: 14px;
        }

        /* Metrics */
        .analysis-content .metric-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 0;
            border-bottom: 1px solid rgba(30,45,61,0.5);
        }
        .analysis-content .metric-row:last-child { border-bottom: none; }
        .analysis-content .metric-label {
            color: #8b949e;
            font-size: 11px;
        }
        .analysis-content .metric-value {
            font-weight: 600;
            font-size: 12px;
        }
        .analysis-content .metric-value.good { color: #00ff88; }
        .analysis-content .metric-value.warning { color: #ff9500; }
        .analysis-content .metric-value.bad { color: #ff4444; }
        .analysis-content .metric-value.neutral { color: #e6edf3; }

        /* Higgons Score */
        .analysis-content .higgons-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 8px;
        }
        .analysis-content .higgons-criteria {
            display: grid;
            grid-template-columns: auto 1fr auto auto;
            gap: 10px;
            align-items: center;
            padding: 8px 10px;
            background: #0a0e14;
            border-radius: 3px;
            border-left: 3px solid transparent;
        }
        .analysis-content .higgons-criteria.pass { border-left-color: #00ff88; }
        .analysis-content .higgons-criteria.fail { border-left-color: #ff4444; }
        .analysis-content .higgons-criteria.partial { border-left-color: #ff9500; }
        .analysis-content .criteria-icon {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: 700;
        }
        .analysis-content .criteria-icon.pass { background: rgba(0,255,136,0.15); color: #00ff88; }
        .analysis-content .criteria-icon.fail { background: rgba(255,68,68,0.15); color: #ff4444; }
        .analysis-content .criteria-icon.partial { background: rgba(255,149,0,0.15); color: #ff9500; }
        .analysis-content .criteria-name { font-size: 11px; color: #e6edf3; }
        .analysis-content .criteria-target { font-size: 10px; color: #484f58; }
        .analysis-content .criteria-actual { font-size: 11px; font-weight: 600; }

        /* Score Badge */
        .analysis-content .score-badge {
            text-align: center;
            padding: 16px;
            margin-top: 10px;
            background: #0a0e14;
            border-radius: 4px;
        }
        .analysis-content .score-badge .score-num {
            font-size: 36px;
            font-weight: 700;
        }
        .analysis-content .score-badge .score-label {
            font-size: 10px;
            color: #484f58;
            letter-spacing: 1px;
            text-transform: uppercase;
            margin-top: 2px;
        }

        /* Financial Table */
        .analysis-content .fin-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 11px;
        }
        .analysis-content .fin-table th {
            text-align: right;
            padding: 6px 8px;
            color: #484f58;
            font-weight: 500;
            font-size: 10px;
            border-bottom: 1px solid #1e2d3d;
        }
        .analysis-content .fin-table th:first-child { text-align: left; }
        .analysis-content .fin-table td {
            text-align: right;
            padding: 5px 8px;
            border-bottom: 1px solid rgba(30,45,61,0.3);
        }
        .analysis-content .fin-table td:first-child {
            text-align: left;
            color: #8b949e;
        }
        .analysis-content .fin-table tr:hover { background: rgba(0,255,136,0.02); }

        /* SWOT */
        .analysis-content .swot-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        .analysis-content .swot-box {
            padding: 12px;
            border-radius: 3px;
            background: #0a0e14;
        }
        .analysis-content .swot-box h4 {
            font-size: 10px;
            letter-spacing: 1.5px;
            text-transform: uppercase;
            margin-bottom: 8px;
            padding-bottom: 4px;
            border-bottom: 1px solid #1e2d3d;
        }
        .analysis-content .swot-box.strength h4 { color: #00ff88; }
        .analysis-content .swot-box.weakness h4 { color: #ff4444; }
        .analysis-content .swot-box.opportunity h4 { color: #58a6ff; }
        .analysis-content .swot-box.threat h4 { color: #ff9500; }
        .analysis-content .swot-box ul { list-style: none; padding: 0; }
        .analysis-content .swot-box li {
            font-size: 10px;
            color: #8b949e;
            padding: 3px 0;
            padding-left: 12px;
            position: relative;
            line-height: 1.5;
        }
        .analysis-content .swot-box li::before {
            content: '‚Ä∫';
            position: absolute;
            left: 0;
            font-weight: 700;
        }
        .analysis-content .swot-box.strength li::before { color: #00ff88; }
        .analysis-content .swot-box.weakness li::before { color: #ff4444; }
        .analysis-content .swot-box.opportunity li::before { color: #58a6ff; }
        .analysis-content .swot-box.threat li::before { color: #ff9500; }

        /* Tags */
        .analysis-content .tag {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 2px;
            font-size: 9px;
            font-weight: 600;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }
        .analysis-content .tag.buy { background: rgba(0,255,136,0.12); color: #00ff88; border: 1px solid rgba(0,255,136,0.3); }
        .analysis-content .tag.hold { background: rgba(255,149,0,0.12); color: #ff9500; border: 1px solid rgba(255,149,0,0.3); }
        .analysis-content .tag.sell { background: rgba(255,68,68,0.12); color: #ff4444; border: 1px solid rgba(255,68,68,0.3); }
        .analysis-content .tag.info { background: rgba(88,166,255,0.12); color: #58a6ff; border: 1px solid rgba(88,166,255,0.3); }

        /* Progress Bar */
        .analysis-content .progress-container {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 4px 0;
        }
        .analysis-content .progress-bar {
            flex: 1;
            height: 4px;
            background: #0a0e14;
            border-radius: 2px;
            overflow: hidden;
        }
        .analysis-content .progress-fill {
            height: 100%;
            border-radius: 2px;
            transition: width 0.3s;
        }
        .analysis-content .progress-label {
            font-size: 10px;
            color: #484f58;
            min-width: 30px;
        }

        /* Narrative */
        .analysis-content .narrative {
            padding: 14px;
            font-size: 11px;
            color: #8b949e;
            line-height: 1.8;
        }
        .analysis-content .narrative p { margin-bottom: 10px; }
        .analysis-content .narrative strong { color: #e6edf3; }
        .analysis-content .narrative .highlight-green { color: #00ff88; }
        .analysis-content .narrative .highlight-red { color: #ff4444; }
        .analysis-content .narrative .highlight-orange { color: #ff9500; }

        /* Section Title */
        .analysis-content .section-title {
            color: #00ff88;
            font-size: 10px;
            font-weight: 600;
            letter-spacing: 2px;
            text-transform: uppercase;
            margin: 20px 0 12px;
            padding-bottom: 6px;
            border-bottom: 1px solid #1e2d3d;
        }

        /* Separator */
        .analysis-content .sep {
            height: 1px;
            background: #1e2d3d;
            margin: 16px 0;
        }

        /* Full width panel */
        .analysis-content .full-width { margin-bottom: 12px; }

        /* Footer */
        .analysis-content .footer {
            margin-top: 24px;
            padding: 12px;
            text-align: center;
            color: #484f58;
            font-size: 9px;
            border-top: 1px solid #1e2d3d;
        }
        .analysis-content .footer .disclaimer {
            max-width: 800px;
            margin: 0 auto;
            line-height: 1.6;
        }

        /* Live dot animation */
        .analysis-content .live-dot {
            display: inline-block;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #00ff88;
            animation: analyseBlink 1.5s infinite;
            margin-right: 4px;
        }
        @keyframes analyseBlink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }

        @media (max-width: 900px) {
            .analysis-content .swot-grid { grid-template-columns: 1fr; }
            .analysis-content .ticker-header { grid-template-columns: 1fr; }
        }
    </style>

    <div class="bb-chart-container">
        <div class="bb-chart-header">
            <span class="bb-chart-title">üìà Price History (1 Year)</span>
            <div class="bb-chart-period">
                <button onclick="setChartPeriod(30)" id="btn-1m">1M</button>
                <button onclick="setChartPeriod(90)" id="btn-3m">3M</button>
                <button onclick="setChartPeriod(180)" id="btn-6m">6M</button>
                <button onclick="setChartPeriod(365)" id="btn-1y" class="active">1Y</button>
            </div>
        </div>
        <div class="bb-chart"><canvas id="priceChart"></canvas></div>
        <div class="bb-chart-stats">
            <div class="bb-chart-stat"><span class="bb-chart-stat-label">1M Perf</span><span class="bb-chart-stat-value {{ 'pos' if perf_1m >= 0 else 'neg' }}">{{ '+' if perf_1m >= 0 else '' }}{{ "%.1f"|format(perf_1m) }}%</span></div>
            <div class="bb-chart-stat"><span class="bb-chart-stat-label">3M Perf</span><span class="bb-chart-stat-value {{ 'pos' if perf_3m >= 0 else 'neg' }}">{{ '+' if perf_3m >= 0 else '' }}{{ "%.1f"|format(perf_3m) }}%</span></div>
            <div class="bb-chart-stat"><span class="bb-chart-stat-label">1Y Perf</span><span class="bb-chart-stat-value {{ 'pos' if perf_1y >= 0 else 'neg' }}">{{ '+' if perf_1y >= 0 else '' }}{{ "%.1f"|format(perf_1y) }}%</span></div>
            <div class="bb-chart-stat"><span class="bb-chart-stat-label">52W High</span><span class="bb-chart-stat-value">{{ fmt(high_1y) }}</span></div>
            <div class="bb-chart-stat"><span class="bb-chart-stat-label">52W Low</span><span class="bb-chart-stat-value">{{ fmt(low_1y) }}</span></div>
        </div>
    </div>

    <div class="bb-detail-grid">
        <div class="bb-detail-card"><h3>Valuation</h3>
            <div class="bb-metric"><span class="bb-metric-label">P/E (TTM)</span><span class="bb-metric-val">{{ fmt(pe, dec=1) }}</span></div>
            <div class="bb-metric"><span class="bb-metric-label">P/E (FWD)</span><span class="bb-metric-val">{{ fmt(forward_pe, dec=1) }}</span></div>
            <div class="bb-metric"><span class="bb-metric-label">EPS</span><span class="bb-metric-val">{{ fmt(eps) }}</span></div>
            <div class="bb-metric"><span class="bb-metric-label">Book Value</span><span class="bb-metric-val">{{ fmt(book_value) }}</span></div>
            <div class="bb-metric"><span class="bb-metric-label">Target Price</span><span class="bb-metric-val">{{ fmt(target_price) }}</span></div>
        </div>

        <div class="bb-detail-card"><h3>Returns</h3>
            <div class="bb-metric"><span class="bb-metric-label">ROE</span><span class="bb-metric-val {{ 'pos' if roe and roe > 0.10 else '' }}">{{ pct(roe) }}</span></div>
            <div class="bb-metric"><span class="bb-metric-label">Profit Margin</span><span class="bb-metric-val">{{ pct(profit_margin) }}</span></div>
            <div class="bb-metric"><span class="bb-metric-label">Dividend Yield</span><span class="bb-metric-val">{{ pct(dividend_yield) }}</span></div>
            <div class="bb-metric"><span class="bb-metric-label">Beta</span><span class="bb-metric-val">{{ fmt(beta) }}</span></div>
        </div>

        <div class="bb-detail-card"><h3>Trading Data</h3>
            <div class="bb-metric"><span class="bb-metric-label">Market Cap</span><span class="bb-metric-val">{{ fmt(market_cap) }}</span></div>
            <div class="bb-metric"><span class="bb-metric-label">52W High</span><span class="bb-metric-val">{{ fmt(high_52w) }}</span></div>
            <div class="bb-metric"><span class="bb-metric-label">52W Low</span><span class="bb-metric-val">{{ fmt(low_52w) }}</span></div>
            <div class="bb-metric"><span class="bb-metric-label">Volume</span><span class="bb-metric-val">{{ fmt(volume, dec=0) }}</span></div>
            <div class="bb-metric"><span class="bb-metric-label">Avg Volume</span><span class="bb-metric-val">{{ fmt(avg_volume, dec=0) }}</span></div>
        </div>

        <div class="bb-detail-card"><h3>Financial Health</h3>
            <div class="bb-metric"><span class="bb-metric-label">Revenue</span><span class="bb-metric-val">{{ fmt(revenue) }}</span></div>
            <div class="bb-metric"><span class="bb-metric-label">Debt/Equity</span><span class="bb-metric-val {{ 'neg' if debt_equity and debt_equity > 100 else '' }}">{{ fmt(debt_equity, dec=1) }}</span></div>
            <div class="bb-metric"><span class="bb-metric-label">Current Ratio</span><span class="bb-metric-val">{{ fmt(current_ratio) }}</span></div>
            <div class="bb-metric"><span class="bb-metric-label">Employees</span><span class="bb-metric-val">{{ fmt(employees, dec=0) }}</span></div>
        </div>

        <div class="bb-detail-card bb-dividend-section" id="dividend-section">
            <h3>üí∞ Dividends</h3>
            <div id="dividend-loading" style="color:#666;font-size:11px;text-align:center;padding:20px;">Loading dividend data...</div>
            <div id="dividend-content" style="display:none;">
                <div class="bb-metric"><span class="bb-metric-label">Annual Dividend</span><span class="bb-metric-val" id="div-annual">-</span></div>
                <div class="bb-metric"><span class="bb-metric-label">Dividend Yield</span><span class="bb-metric-val" id="div-yield-detail">-</span></div>
                <div class="bb-metric"><span class="bb-metric-label">Frequency</span><span class="bb-metric-val" id="div-freq">-</span></div>
                <div class="bb-metric"><span class="bb-metric-label">5Y Growth (CAGR)</span><span class="bb-metric-val" id="div-growth">-</span></div>
                <div class="bb-metric"><span class="bb-metric-label">Next Ex-Date</span><span class="bb-metric-val" id="div-next">-</span></div>
                <div id="div-history-mini" style="margin-top:10px;border-top:1px solid #333;padding-top:10px;">
                    <div style="color:#888;font-size:9px;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:6px;">Recent Payments</div>
                    <div id="div-history-list" style="max-height:100px;overflow-y:auto;"></div>
                </div>
            </div>
            <div id="dividend-empty" style="display:none;color:#666;font-size:11px;text-align:center;padding:15px;font-style:italic;">No dividend history available for this security.</div>
        </div>

        <div class="bb-detail-card bb-detail-desc"><h3>Business Description</h3>
            <p>{% if description %}{{ (description[:800] + '...') if description|length > 800 else description }}{% else %}No description available.{% endif %}</p>
            {% if website %}<p style="margin-top:8px"><a href="{{ website }}" target="_blank" style="color:#00bfff">{{ website }}</a></p>{% endif %}
        </div>

        <div class="bb-detail-card bb-memo-section"><h3>Investment Memo</h3>{{ memo_html|safe }}</div>
    </div>
</div>

<div class="bb-status"><div class="bb-status-l">BLOOMBERG LP | {{ ticker }} | {{ current_datetime }}</div><div class="bb-status-r">Connected <span class="blink">‚óè</span></div></div>

<script>
// Add to watchlist from detail page
function addToWatchlistDetail(btn) {
    const ticker = '{{ ticker }}';
    const name = '{{ name or ticker }}';
    const country = '{{ country or "" }}';
    const sector = '{{ sector or "" }}';

    fetch(`/?action=addwatch&ticker=${ticker}&name=${encodeURIComponent(name)}&country=${country}&sector=${encodeURIComponent(sector)}`)
        .then(r => r.text())
        .then(() => {
            alert('‚úì ' + ticker + ' added to watchlist');
            btn.textContent = '‚úì IN WATCHLIST';
            btn.disabled = true;
            btn.style.opacity = '0.6';
        })
        .catch(err => {
            alert('Error adding to watchlist: ' + err);
        });
}

// Alert configuration functions
function toggleAlertConfig() {
    const panel = document.getElementById('alert-config-panel');
    panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
}

function saveAlertConfig() {
    const ticker = '{{ ticker }}';
    const pe = document.getElementById('alert-pe').value;
    const roe = document.getElementById('alert-roe').value;
    const priceBelow = document.getElementById('alert-price-below').value;
    const priceAbove = document.getElementById('alert-price-above').value;

    let url = `/?action=set_alert_config&ticker=${ticker}`;
    if (pe) url += `&pe_threshold=${pe}`;
    if (roe) url += `&roe_threshold=${roe}`;
    if (priceBelow) url += `&price_below=${priceBelow}`;
    if (priceAbove) url += `&price_above=${priceAbove}`;

    fetch(url)
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                alert('‚úì Alert configuration saved for ' + ticker);
                toggleAlertConfig();
            } else {
                alert('Error: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(err => {
            alert('Error saving alert config: ' + err);
        });
}

// Clock update
setInterval(() => {
    var now = new Date();
    document.querySelector('.bb-time').innerHTML =
        ('0' + now.getHours()).slice(-2) + ':' +
        ('0' + now.getMinutes()).slice(-2) + ':' +
        ('0' + now.getSeconds()).slice(-2) + ' CET <span class="blink">‚óè</span>';
}, 1000);

// Chart data and rendering
const allData = {{ price_history_json|safe }};
let currentPeriod = 365;

function setChartPeriod(days) {
    currentPeriod = days;
    document.querySelectorAll('.bb-chart-period button').forEach(b => b.classList.remove('active'));
    document.getElementById('btn-' + (days === 30 ? '1m' : days === 90 ? '3m' : days === 180 ? '6m' : '1y')).classList.add('active');
    drawChart();
}

function drawChart() {
    const canvas = document.getElementById('priceChart');
    if (!canvas || !allData.length) return;

    const ctx = canvas.getContext('2d');
    const rect = canvas.parentElement.getBoundingClientRect();
    canvas.width = rect.width;
    canvas.height = rect.height;

    // Filter data by period
    const data = allData.slice(-currentPeriod);
    if (data.length < 2) return;

    const prices = data.map(d => d.close);
    const minPrice = Math.min(...prices);
    const maxPrice = Math.max(...prices);
    const priceRange = maxPrice - minPrice || 1;

    const padding = { top: 20, right: 60, bottom: 30, left: 10 };
    const chartWidth = canvas.width - padding.left - padding.right;
    const chartHeight = canvas.height - padding.top - padding.bottom;

    // Clear canvas
    ctx.fillStyle = '#050505';
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    // Draw grid lines
    ctx.strokeStyle = '#1a1a1a';
    ctx.lineWidth = 1;
    for (let i = 0; i <= 4; i++) {
        const y = padding.top + (chartHeight / 4) * i;
        ctx.beginPath();
        ctx.moveTo(padding.left, y);
        ctx.lineTo(canvas.width - padding.right, y);
        ctx.stroke();

        // Price labels
        const price = maxPrice - (priceRange / 4) * i;
        ctx.fillStyle = '#666';
        ctx.font = '10px JetBrains Mono';
        ctx.textAlign = 'left';
        ctx.fillText(price.toFixed(2), canvas.width - padding.right + 5, y + 4);
    }

    // Determine if positive or negative trend
    const isPositive = prices[prices.length - 1] >= prices[0];
    const lineColor = isPositive ? '#00ff00' : '#ff3b30';
    const fillColor = isPositive ? 'rgba(0, 255, 0, 0.1)' : 'rgba(255, 59, 48, 0.1)';

    // Draw area fill
    ctx.beginPath();
    ctx.moveTo(padding.left, padding.top + chartHeight);
    data.forEach((d, i) => {
        const x = padding.left + (i / (data.length - 1)) * chartWidth;
        const y = padding.top + ((maxPrice - d.close) / priceRange) * chartHeight;
        ctx.lineTo(x, y);
    });
    ctx.lineTo(padding.left + chartWidth, padding.top + chartHeight);
    ctx.closePath();
    ctx.fillStyle = fillColor;
    ctx.fill();

    // Draw price line
    ctx.beginPath();
    ctx.strokeStyle = lineColor;
    ctx.lineWidth = 2;
    data.forEach((d, i) => {
        const x = padding.left + (i / (data.length - 1)) * chartWidth;
        const y = padding.top + ((maxPrice - d.close) / priceRange) * chartHeight;
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
    });
    ctx.stroke();

    // Draw current price line
    const lastPrice = prices[prices.length - 1];
    const lastY = padding.top + ((maxPrice - lastPrice) / priceRange) * chartHeight;
    ctx.strokeStyle = lineColor;
    ctx.setLineDash([5, 3]);
    ctx.beginPath();
    ctx.moveTo(padding.left, lastY);
    ctx.lineTo(canvas.width - padding.right, lastY);
    ctx.stroke();
    ctx.setLineDash([]);

    // Draw current price label
    ctx.fillStyle = lineColor;
    ctx.font = 'bold 11px JetBrains Mono';
    ctx.fillText(lastPrice.toFixed(2), canvas.width - padding.right + 5, lastY + 4);

    // Draw date labels
    ctx.fillStyle = '#666';
    ctx.font = '9px JetBrains Mono';
    ctx.textAlign = 'center';
    const labelCount = Math.min(6, data.length);
    for (let i = 0; i < labelCount; i++) {
        const idx = Math.floor((i / (labelCount - 1)) * (data.length - 1));
        const x = padding.left + (idx / (data.length - 1)) * chartWidth;
        const date = new Date(data[idx].date);
        const label = date.toLocaleDateString('fr-FR', { month: 'short', day: 'numeric' });
        ctx.fillText(label, x, canvas.height - 10);
    }
}

// Initial draw
setTimeout(drawChart, 100);
window.addEventListener('resize', drawChart);

// Memo form toggle
function toggleMemoForm() {
    const form = document.getElementById('memoForm');
    form.classList.toggle('active');
}

// Generate memo with AI
function generateAIMemo() {
    const btn = document.getElementById('aiGenBtn');
    if (!btn) return;

    const originalText = btn.innerHTML;
    btn.innerHTML = '‚Üª Generating with AI...';
    btn.disabled = true;
    btn.style.opacity = '0.6';

    fetch('/?action=generate_ai_memo&ticker={{ ticker }}', {
        method: 'POST'
    }).then(response => response.json())
    .then(result => {
        if (result.success) {
            alert('AI Memo generated successfully!');
            location.reload();
        } else {
            alert('Error generating memo: ' + result.error);
            btn.innerHTML = originalText;
            btn.disabled = false;
            btn.style.opacity = '1';
        }
    }).catch(err => {
        alert('Error: ' + err);
        btn.innerHTML = originalText;
        btn.disabled = false;
        btn.style.opacity = '1';
    });
}

// Handle memo form submission
document.getElementById('createMemoForm')?.addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    fetch('/?action=create_memo', {
        method: 'POST',
        body: formData
    }).then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Memo created successfully!');
            location.reload();
        } else {
            alert('Error creating memo: ' + data.error);
        }
    }).catch(err => {
        alert('Error: ' + err);
    });
});

// Load dividend data for this ticker
function loadTickerDividends() {
    const ticker = '{{ ticker }}';
    fetch(`/?action=dividends_ticker&ticker=${ticker}&years=5`)
        .then(r => r.json())
        .then(data => {
            const loading = document.getElementById('dividend-loading');
            const content = document.getElementById('dividend-content');
            const empty = document.getElementById('dividend-empty');

            if (data.error) {
                loading.style.display = 'none';
                empty.style.display = 'block';
                return;
            }

            // Check if there's dividend data
            if (!data.history || data.history.length === 0) {
                loading.style.display = 'none';
                empty.style.display = 'block';
                return;
            }

            // Populate dividend metrics
            document.getElementById('div-annual').textContent = data.annual_dividend > 0 ? '‚Ç¨' + data.annual_dividend.toFixed(2) : '-';
            document.getElementById('div-yield-detail').textContent = data.dividend_yield > 0 ? data.dividend_yield.toFixed(2) + '%' : '-';
            document.getElementById('div-freq').textContent = data.frequency ? data.frequency.charAt(0).toUpperCase() + data.frequency.slice(1) : '-';
            document.getElementById('div-growth').textContent = data.dividend_growth_5y !== null ? (data.dividend_growth_5y >= 0 ? '+' : '') + data.dividend_growth_5y.toFixed(1) + '%' : '-';
            document.getElementById('div-next').textContent = data.next_ex_date || '-';

            // Add growth color
            const growthEl = document.getElementById('div-growth');
            if (data.dividend_growth_5y !== null) {
                growthEl.classList.add(data.dividend_growth_5y >= 0 ? 'pos' : 'neg');
            }

            // Show recent payments
            const historyList = document.getElementById('div-history-list');
            const recent = data.history.slice(0, 5);
            historyList.innerHTML = recent.map(d => `
                <div style="display:flex;justify-content:space-between;padding:3px 0;font-size:10px;border-bottom:1px solid #1a1a1a;">
                    <span style="color:#888;">${ d.date }</span>
                    <span style="color:#00ff00;">‚Ç¨${d.amount.toFixed(4)}</span>
                </div>
            `).join('');

            loading.style.display = 'none';
            content.style.display = 'block';
        })
        .catch(err => {
            console.error('Error loading dividend data:', err);
            document.getElementById('dividend-loading').style.display = 'none';
            document.getElementById('dividend-empty').style.display = 'block';
        });
}

// Load dividend data on page load
setTimeout(loadTickerDividends, 500);

// ========================================
// AI Equity Research Analysis
// ========================================

let currentAnalysisTicker = null;

function launchAnalysis(ticker) {
    currentAnalysisTicker = ticker;

    // Open modal
    const modal = document.getElementById('analysis-modal');
    modal.style.display = 'flex';

    // Show loading
    document.getElementById('analysis-loading').style.display = 'flex';
    document.getElementById('analysis-content').style.display = 'none';
    document.getElementById('analysis-error').style.display = 'none';

    // Update header
    document.getElementById('analysis-ticker').textContent = ticker;
    document.getElementById('analysis-timestamp').textContent =
        new Date().toLocaleDateString('fr-FR', {
            day: '2-digit', month: 'short', year: 'numeric',
            hour: '2-digit', minute: '2-digit'
        });

    // Update button state
    const btn = document.getElementById('btn-ai-analyze');
    btn.classList.add('loading');
    btn.querySelector('.analyze-text').textContent = 'Analyse...';

    // Animate loading steps
    animateLoadingSteps();

    // API call
    fetch('/api/analysis/stock', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ticker: ticker}),
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('analysis-loading').style.display = 'none';
            const contentEl = document.getElementById('analysis-content');
            contentEl.innerHTML = data.html;
            contentEl.style.display = 'block';
            if (data.from_cache) {
                document.getElementById('analysis-cache-badge').style.display = 'inline';
            }
        } else {
            showAnalysisError(data.error || 'Erreur inconnue');
        }
    })
    .catch(error => {
        showAnalysisError('Erreur de connexion : ' + error.message);
    })
    .finally(() => {
        const btn = document.getElementById('btn-ai-analyze');
        btn.classList.remove('loading');
        btn.querySelector('.analyze-text').textContent = 'Analyser';
        if (window._loadingInterval) clearInterval(window._loadingInterval);
    });
}

function animateLoadingSteps() {
    const steps = ['step-data', 'step-analysis', 'step-report'];
    let current = 0;

    // Reset steps
    steps.forEach(s => {
        const el = document.getElementById(s);
        if (el) {
            el.classList.remove('active', 'done');
        }
    });
    document.getElementById(steps[0]).classList.add('active');

    const interval = setInterval(() => {
        if (current > 0) {
            const prev = document.getElementById(steps[current - 1]);
            if (prev) {
                prev.classList.remove('active');
                prev.classList.add('done');
            }
        }
        current++;
        if (current < steps.length) {
            document.getElementById(steps[current]).classList.add('active');
        } else {
            clearInterval(interval);
        }
    }, 3000);

    window._loadingInterval = interval;
}

function showAnalysisError(message) {
    document.getElementById('analysis-loading').style.display = 'none';
    document.getElementById('analysis-content').style.display = 'none';
    document.getElementById('analysis-error').style.display = 'flex';
    document.getElementById('error-message').textContent = message;
    if (window._loadingInterval) clearInterval(window._loadingInterval);
}

function closeAnalysis() {
    document.getElementById('analysis-modal').style.display = 'none';
    if (window._loadingInterval) clearInterval(window._loadingInterval);
}

function retryAnalysis() {
    if (currentAnalysisTicker) {
        launchAnalysis(currentAnalysisTicker);
    }
}

function refreshAnalysis() {
    if (!currentAnalysisTicker) return;

    // Force refresh (bypass cache)
    document.getElementById('analysis-loading').style.display = 'flex';
    document.getElementById('analysis-content').style.display = 'none';
    document.getElementById('analysis-error').style.display = 'none';
    document.getElementById('analysis-cache-badge').style.display = 'none';

    animateLoadingSteps();

    fetch('/?action=analyze_stock&ticker=' + currentAnalysisTicker, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ force_refresh: true }),
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('analysis-loading').style.display = 'none';
            const contentEl = document.getElementById('analysis-content');
            contentEl.innerHTML = data.html;
            contentEl.style.display = 'block';
        } else {
            showAnalysisError(data.error || 'Erreur inconnue');
        }
    })
    .catch(error => {
        showAnalysisError('Erreur de connexion : ' + error.message);
    })
    .finally(() => {
        if (window._loadingInterval) clearInterval(window._loadingInterval);
    });
}

function printAnalysis() {
    const content = document.getElementById('analysis-content').innerHTML;
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <html>
        <head>
            <title>Olyos Capital ‚Äî Equity Research</title>
            <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700&display=swap" rel="stylesheet">
            <style>
                :root {
                    --bg-primary: #0a0e14; --bg-secondary: #111822; --bg-tertiary: #1a2332;
                    --border: #1e2d3d; --text-primary: #e6edf3; --text-secondary: #8b949e;
                    --text-muted: #484f58; --green: #00ff88; --red: #ff4444; --orange: #ff9500;
                    --yellow: #ffd700; --blue: #58a6ff; --cyan: #00d4ff;
                }
                * { margin: 0; padding: 0; box-sizing: border-box; }
                body { font-family: 'JetBrains Mono', monospace; background: var(--bg-primary); color: var(--text-primary); font-size: 12px; line-height: 1.6; padding: 16px; max-width: 1400px; margin: 0 auto; }
                ${document.getElementById('analysis-styles').textContent}
            </style>
        </head>
        <body>${content}</body>
        </html>
    `);
    printWindow.document.close();
    printWindow.print();
}

function downloadAnalysis() {
    const content = document.getElementById('analysis-content').innerHTML;
    const ticker = currentAnalysisTicker;
    const date = new Date().toISOString().split('T')[0];

    const fullHtml = `<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Olyos Capital ‚Äî ${ticker} ‚Äî Equity Research</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
    --bg-primary: #0a0e14; --bg-secondary: #111822; --bg-tertiary: #1a2332;
    --border: #1e2d3d; --text-primary: #e6edf3; --text-secondary: #8b949e;
    --text-muted: #484f58; --green: #00ff88; --red: #ff4444; --orange: #ff9500;
    --yellow: #ffd700; --blue: #58a6ff; --cyan: #00d4ff;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: 'JetBrains Mono', monospace; background: var(--bg-primary); color: var(--text-primary); font-size: 12px; line-height: 1.6; padding: 16px; max-width: 1400px; margin: 0 auto; }
${document.getElementById('analysis-styles').textContent}
</style>
</head>
<body>${content}</body>
</html>`;

    const blob = new Blob([fullHtml], { type: 'text/html' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${ticker}_equity_research_${date}.html`;
    a.click();
    URL.revokeObjectURL(url);
}

// Close modal with Escape
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') closeAnalysis();
});
</script>

<!-- Analysis Modal -->
<div id="analysis-modal" class="analysis-modal" style="display:none;">
    <div class="analysis-modal-header">
        <div class="analysis-modal-logo">‚óÜ OLYOS CAPITAL</div>
        <div class="analysis-modal-meta">
            EQUITY RESEARCH ‚îÇ <span id="analysis-ticker"></span> ‚îÇ
            <span id="analysis-timestamp"></span>
            <span id="analysis-cache-badge" class="analysis-cache-badge" style="display:none;">CACHE</span>
        </div>
        <div class="analysis-modal-actions">
            <button onclick="refreshAnalysis()" class="modal-btn" title="Rafra√Æchir (ignorer le cache)">‚Üª</button>
            <button onclick="printAnalysis()" class="modal-btn" title="Imprimer">‚éô</button>
            <button onclick="downloadAnalysis()" class="modal-btn" title="T√©l√©charger HTML">‚Üì</button>
            <button onclick="closeAnalysis()" class="modal-btn modal-btn-close" title="Fermer">‚úï</button>
        </div>
    </div>

    <div id="analysis-loading" class="analysis-loading" style="display:none;">
        <div class="loading-spinner"></div>
        <div class="loading-text">Analyse en cours...</div>
        <div class="loading-subtext">Claude g√©n√®re le rapport d'equity research</div>
        <div class="loading-steps">
            <div class="loading-step active" id="step-data">‚ñ∏ Collecte des donn√©es financi√®res</div>
            <div class="loading-step" id="step-analysis">‚ñ∏ Analyse m√©thode Higgons</div>
            <div class="loading-step" id="step-report">‚ñ∏ G√©n√©ration du rapport</div>
        </div>
    </div>

    <div id="analysis-content" class="analysis-content" style="display:none;"></div>

    <div id="analysis-error" class="analysis-error" style="display:none;">
        <div class="error-icon">‚ö†</div>
        <div class="error-text" id="error-message"></div>
        <button onclick="retryAnalysis()" class="btn-analyze" style="margin-top:12px;">‚óÜ R√©essayer</button>
    </div>
</div>

{% endblock %}
